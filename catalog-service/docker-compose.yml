version: '3.8'
# 自定义网络：确保所有服务在同一网络，支持容器名访问
networks:
  course-network:
    driver: bridge

# 数据卷：持久化数据库数据，避免容器重启后数据丢失
volumes:
  catalog-data:  # 课程目录服务数据库数据卷
  enrollment-data:  # 选课服务数据库数据卷

services:
  # 1. 课程目录服务数据库（适配你的数据库账号密码）
  catalog-db:
    image: mysql:8.4  # 适配MySQL8Dialect，与你的JPA配置匹配
    container_name: catalog-db
    environment:
      MYSQL_ROOT_PASSWORD: lilili2004  # 根密码（可自定义，建议与业务账号区分）
      MYSQL_DATABASE: coursehub  # 数据库名：与你Spring配置中的“coursehub”一致
      MYSQL_USER: lilili2004  # 业务账号：与你Spring配置的“username: lilili2004”一致
      MYSQL_PASSWORD: lilili2004  # 业务密码：与你Spring配置的“password: lilili2004”一致
    ports:
      - "3307:3306"  # 端口映射：避免与本地MySQL冲突（宿主机3307→容器3306）
    volumes:
      - catalog-data:/var/lib/mysql  # 挂载数据卷
    networks:
      - course-network
    command:
      - --character-set-server=utf8mb4  # 解决中文乱码
      - --collation-server=utf8mb4_unicode_ci
    healthcheck:  # 健康检查：确保数据库就绪后再启动服务
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. 选课服务数据库（同课程目录服务账号密码，保持一致性）
  enrollment-db:
    image: mysql:8.4  # 适配MySQL8Dialect
    container_name: enrollment-db
    environment:
      MYSQL_ROOT_PASSWORD: lilili2004
      MYSQL_DATABASE: coursehub_enroll  # 选课服务独立数据库（避免与课程服务数据混淆）
      MYSQL_USER: lilili2004  # 与你Spring配置的账号一致
      MYSQL_PASSWORD: lilili2004  # 与你Spring配置的密码一致
    ports:
      - "3308:3306"  # 独立端口：宿主机3308→容器3306
    volumes:
      - enrollment-data:/var/lib/mysql  # 挂载数据卷
    networks:
      - course-network
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3. 课程目录服务（catalog-service）：适配你的Spring配置
  catalog-service:
    build:
      context: ./catalog-service  # 服务源码目录（需与你的项目结构一致）
      dockerfile: Dockerfile  # 对应服务的Dockerfile
    container_name: catalog-service
    environment:
      SPRING_PROFILES_ACTIVE: prod  # 启用生产环境配置
      # 数据库连接URL：容器名“catalog-db”+数据库名“coursehub”，与你的配置对齐
      SPRING_DATASOURCE_URL: jdbc:mysql://catalog-db:3306/coursehub?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: lilili2004  # 与你的配置一致
      SPRING_DATASOURCE_PASSWORD: lilili2004  # 与你的配置一致
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver  # 与你的驱动配置一致
      # JPA配置：与你的Hibernate配置对齐
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: true
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: true
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.MySQL8Dialect
      # 日志配置：与你的包路径“com.zjgsu.lll.course2_new”一致
      LOGGING_LEVEL_COM_ZJGSU_LLL_COURSE2_NEW: DEBUG
      LOGGING_LEVEL_ROOT: INFO
    ports:
      - "8081:8081"  # 服务端口：与微服务拆分要求一致
    depends_on:
      catalog-db:
        condition: service_healthy  # 依赖数据库健康检查通过
    networks:
      - course-network
    restart: unless-stopped  # 服务异常自动重启

  # 4. 选课服务（enrollment-service）：适配你的Spring配置+服务间通信
  enrollment-service:
    build:
      context: ./enrollment-service  # 服务源码目录
      dockerfile: Dockerfile
    container_name: enrollment-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      # 数据库连接URL：容器名“enrollment-db”+数据库名“coursehub_enroll”
      SPRING_DATASOURCE_URL: jdbc:mysql://enrollment-db:3306/coursehub_enroll?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: lilili2004  # 与你的配置一致
      SPRING_DATASOURCE_PASSWORD: lilili2004  # 与你的配置一致
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver  # 与你的驱动配置一致
      # JPA配置：与你的Hibernate配置对齐
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: true
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: true
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.MySQL8Dialect
      # 日志配置：与你的包路径一致
      LOGGING_LEVEL_COM_ZJGSU_LLL_COURSE2_NEW: DEBUG
      LOGGING_LEVEL_ROOT: INFO
      # 服务间通信：调用课程目录服务的地址（容器名+端口）
      CATALOG_SERVICE_URL: http://catalog-service:8081
    ports:
      - "8082:8082"  # 服务端口：与微服务拆分要求一致
    depends_on:
      enrollment-db:
        condition: service_healthy  # 依赖数据库健康检查通过
      catalog-service:
        condition: service_started  # 依赖课程服务启动
    networks:
      - course-network
    restart: unless-stopped